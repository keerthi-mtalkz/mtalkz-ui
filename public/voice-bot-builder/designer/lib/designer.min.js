(function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self,t.sequentialWorkflowDesigner=e())})(this,function(){"use strict";function t(t){return new l(t.clientX,t.clientY)}function e(t){if(t.touches.length>0){const e=t.touches[0];return new l(e.clientX,e.clientY)}throw new Error("Unknown touch position")}function s(t,e){function s(){const s=Math.min((Date.now()-n)/t,1);e(s),1===s&&o.stop()}const i=setInterval(s,15),n=Date.now(),o={isAlive:!0,stop:()=>{o.isAlive=!1,clearInterval(i)}};return o}function i(t,e){t.addEventListener("click",t=>{t.preventDefault(),e()},!1)}function n(t,e){const s=C.element("div",{class:"sqd-control-bar-button",title:e}),i=f.create("sqd-control-bar-button-icon",t);return s.appendChild(i),s}function o(t,e,s){const i=C.svg("rect",{class:"sqd-placeholder",width:L,height:V,x:e,y:s,rx:6,ry:6,visibility:"hidden"});return t.appendChild(i),i}function r(t){const e=d.deepClone(t);return e.id=u.next(),e}function a(t,e,s){function i(){r||(r=!0,setTimeout(()=>{try{o.forward(n)}finally{r=!1,n.fill(void 0)}},t))}const n=[void 0,void 0],o=new p;let r=!1;return[e,s].filter(t=>t).forEach((t,e)=>{t.subscribe(t=>{n[e]=t,i()})}),o}function c(t){const e=C.svg("circle",{class:"sqd-start-stop",cx:Mt/2,cy:Mt/2,r:Mt/2}),s=C.svg("g");s.appendChild(e);const i=.5*Mt,n=(Mt-i)/2;if(t){const t=C.svg("path",{class:"sqd-start-stop-icon",transform:`translate(${n}, ${n})`,d:`M ${.2*i} 0 L ${i} ${i/2} L ${.2*i} ${i} Z`});s.appendChild(t)}else{const t=C.svg("rect",{class:"sqd-start-stop-icon",x:n,y:n,width:i,height:i,rx:4,ry:4});s.appendChild(t)}return s}class l{constructor(t,e){this.x=t,this.y=e}add(t){return new l(this.x+t.x,this.y+t.y)}subtract(t){return new l(this.x-t.x,this.y-t.y)}multiplyByScalar(t){return new l(this.x*t,this.y*t)}divideByScalar(t){return new l(this.x/t,this.y/t)}round(){return new l(Math.round(this.x),Math.round(this.y))}distance(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))}}class h{constructor(){this.onMouseMoveHandler=(t=>this.onMouseMove(t)),this.onMouseUpHandler=(t=>this.onMouseUp(t)),this.onTouchMoveHandler=(t=>this.onTouchMove(t)),this.onTouchEndHandler=(t=>this.onTouchEnd(t)),this.onTouchStartHandler=(t=>this.onTouchStart(t))}start(t,e){this.state?this.stop(!0):(this.state={startPosition:t,behavior:e},e.onStart(this.state.startPosition),window.addEventListener("mousemove",this.onMouseMoveHandler,!1),window.addEventListener("touchmove",this.onTouchMoveHandler,!1),window.addEventListener("mouseup",this.onMouseUpHandler,!1),window.addEventListener("touchend",this.onTouchEndHandler,!1),window.addEventListener("touchstart",this.onTouchStartHandler,!1))}onMouseMove(e){e.preventDefault(),this.move(t(e))}onTouchMove(t){t.preventDefault(),this.move(e(t))}onMouseUp(t){t.preventDefault(),this.stop(!1)}onTouchEnd(t){t.preventDefault(),this.stop(!1)}onTouchStart(t){t.preventDefault(),1!==t.touches.length&&this.stop(!0)}move(t){if(!this.state)throw new Error("State is empty");const e=this.state.startPosition.subtract(t),s=this.state.behavior.onMove(e);s&&(this.state.behavior.onEnd(!0),this.state.behavior=s,this.state.startPosition=t,this.state.behavior.onStart(this.state.startPosition))}stop(t){if(!this.state)throw new Error("State is empty");window.removeEventListener("mousemove",this.onMouseMoveHandler,!1),window.removeEventListener("touchmove",this.onTouchMoveHandler,!1),window.removeEventListener("mouseup",this.onMouseUpHandler,!1),window.removeEventListener("touchend",this.onTouchEndHandler,!1),window.removeEventListener("touchstart",this.onTouchEndHandler,!1),this.state.behavior.onEnd(t),this.state=void 0}}class d{static deepClone(t){return void 0!==window.structuredClone?window.structuredClone(t):JSON.parse(JSON.stringify(t))}}class p{constructor(){this.listeners=[]}subscribe(t){this.listeners.push(t)}unsubscribe(t){const e=this.listeners.indexOf(t);if(!(e>=0))throw new Error("Unknown listener");this.listeners.splice(e,1)}forward(t){this.listeners.length>0&&this.listeners.forEach(e=>e(t))}count(){return this.listeners.length}}class u{static next(){const t=new Uint8Array(16);return window.crypto.getRandomValues(t),Array.from(t,t=>t.toString(16).padStart(2,"0")).join("")}}class g{static moveStep(t,e,s,i){const n=t.indexOf(e);if(n<0)throw new Error("Unknown step");const o=t===s;o&&n===i||(t.splice(n,1),o&&n<i&&i--,s.splice(i,0,e))}static insertStep(t,e,s){e.splice(s,0,t)}static deleteStep(t,e){const s=e.indexOf(t);if(s<0)throw new Error("Unknown step");e.splice(s,1)}}const v=.1,w=3;class m{constructor(t,e,s,i,n,o){this.definition=t,this.behaviorController=e,this.layoutController=s,this.configuration=i,this.isToolboxCollapsed=n,this.isSmartEditorCollapsed=o,this.onViewPortChanged=new p,this.onSelectedStepChanged=new p,this.onIsReadonlyChanged=new p,this.onIsDraggingChanged=new p,this.onIsMoveModeEnabledChanged=new p,this.onIsToolboxCollapsedChanged=new p,this.onIsSmartEditorCollapsedChanged=new p,this.onDefinitionChanged=new p,this.viewPort={position:new l(0,0),scale:1},this.selectedStep=null,this.isDragging=!1,this.isMoveModeEnabled=!1,this.isReadonly=!!i.isReadonly}setViewPort(t,e){this.viewPort={position:t,scale:e},this.onViewPortChanged.forward(this.viewPort)}resetViewPort(){this.getProvider().resetViewPort()}animateViewPort(t,e){this.viewPortAnimation&&this.viewPortAnimation.isAlive&&this.viewPortAnimation.stop();const i=this.viewPort.position,n=this.viewPort.scale,o=i.subtract(t),r=n-e;this.viewPortAnimation=s(150,t=>{const e=n-r*t;this.setViewPort(i.subtract(o.multiplyByScalar(t)),e)})}moveViewPortToStep(t){const e=this.getProvider().findStepComponentById(t);e&&this.getProvider().moveViewPortToStep(e)}limitScale(t){return Math.min(Math.max(t,v),w)}zoom(t){this.getProvider().zoom(t)}setSelectedStep(t){const e=this.selectedStep!==t;this.selectedStep=t,e&&this.onSelectedStepChanged.forward(t)}selectStepById(t){const e=this.getProvider().findStepComponentById(t);e&&this.setSelectedStep(e.step)}deleteStepById(t){var e;const s=this.getProvider().findStepComponentById(t);if(!s)throw new Error("Cannot find component");(null===(e=this.selectedStep)||void 0===e?void 0:e.id)===t&&this.setSelectedStep(null),g.deleteStep(s.step,s.parentSequence),this.notifiyDefinitionChanged()}setIsReadonly(t){this.isReadonly=t,this.onIsReadonlyChanged.forward(t)}setIsDragging(t){this.isDragging=t,this.onIsDraggingChanged.forward(t)}toggleIsMoveModeEnabled(){this.isMoveModeEnabled=!this.isMoveModeEnabled,this.onIsMoveModeEnabledChanged.forward(this.isMoveModeEnabled)}toggleIsToolboxCollapsed(){this.isToolboxCollapsed=!this.isToolboxCollapsed,this.onIsToolboxCollapsedChanged.forward(this.isToolboxCollapsed)}toggleIsSmartEditorCollapsed(){this.isSmartEditorCollapsed=!this.isSmartEditorCollapsed,this.onIsSmartEditorCollapsedChanged.forward(this.isSmartEditorCollapsed)}notifiyDefinitionChanged(){this.onDefinitionChanged.forward(this.definition)}getPlacehodlers(){return this.getProvider().getPlaceholders()}setProvider(t){this.provider=t}getProvider(){if(!this.provider)throw new Error("Provider is not set");return this.provider}}class C{static svg(t,e){const s=document.createElementNS("http://www.w3.org/2000/svg",t);return e&&C.attrs(s,e),s}static translate(t,e,s){t.setAttribute("transform",`translate(${e}, ${s})`)}static attrs(t,e){Object.keys(e).forEach(s=>{const i=e[s];t.setAttribute(s,"string"==typeof i?i:i.toString())})}static element(t,e){const s=document.createElement(t);return e&&C.attrs(s,e),s}static toggleClass(t,e,s){e?t.classList.add(s):t.classList.remove(s)}}class f{static create(t,e){const s=C.svg("svg",{class:t,viewBox:"0 0 24 24"});return e&&(s.innerHTML=e),s}}f.center='<path d="M4 15c-.55 0-1 .45-1 1v3c0 1.1.9 2 2 2h3c.55 0 1-.45 1-1s-.45-1-1-1H6c-.55 0-1-.45-1-1v-2c0-.55-.45-1-1-1zm1-9c0-.55.45-1 1-1h2c.55 0 1-.45 1-1s-.45-1-1-1H5c-1.1 0-2 .9-2 2v3c0 .55.45 1 1 1s1-.45 1-1V6zm14-3h-3c-.55 0-1 .45-1 1s.45 1 1 1h2c.55 0 1 .45 1 1v2c0 .55.45 1 1 1s1-.45 1-1V5c0-1.1-.9-2-2-2zm0 15c0 .55-.45 1-1 1h-2c-.55 0-1 .45-1 1s.45 1 1 1h3c1.1 0 2-.9 2-2v-3c0-.55-.45-1-1-1s-1 .45-1 1v2zM12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>',f.delete='<path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm4.3 14.3a.996.996 0 0 1-1.41 0L12 13.41 9.11 16.3a.996.996 0 1 1-1.41-1.41L10.59 12 7.7 9.11A.996.996 0 1 1 9.11 7.7L12 10.59l2.89-2.89a.996.996 0 1 1 1.41 1.41L13.41 12l2.89 2.89c.38.38.38 1.02 0 1.41z" fill="#E01A24"/>',f.move='<path d="M10.5 9h3c.28 0 .5-.22.5-.5V6h1.79c.45 0 .67-.54.35-.85l-3.79-3.79c-.2-.2-.51-.2-.71 0L7.85 5.15a.5.5 0 0 0 .36.85H10v2.5c0 .28.22.5.5.5zm-2 1H6V8.21c0-.45-.54-.67-.85-.35l-3.79 3.79c-.2.2-.2.51 0 .71l3.79 3.79a.5.5 0 0 0 .85-.36V14h2.5c.28 0 .5-.22.5-.5v-3c0-.28-.22-.5-.5-.5zm14.15 1.65-3.79-3.79a.501.501 0 0 0-.86.35V10h-2.5c-.28 0-.5.22-.5.5v3c0 .28.22.5.5.5H18v1.79c0 .45.54.67.85.35l3.79-3.79c.2-.19.2-.51.01-.7zM13.5 15h-3c-.28 0-.5.22-.5.5V18H8.21c-.45 0-.67.54-.35.85l3.79 3.79c.2.2.51.2.71 0l3.79-3.79a.5.5 0 0 0-.35-.85H14v-2.5c0-.28-.22-.5-.5-.5z"/>',f.options='<path d="M19.5 12c0-.23-.01-.45-.03-.68l1.86-1.41c.4-.3.51-.86.26-1.3l-1.87-3.23a.987.987 0 0 0-1.25-.42l-2.15.91c-.37-.26-.76-.49-1.17-.68l-.29-2.31c-.06-.5-.49-.88-.99-.88h-3.73c-.51 0-.94.38-1 .88l-.29 2.31c-.41.19-.8.42-1.17.68l-2.15-.91c-.46-.2-1-.02-1.25.42L2.41 8.62c-.25.44-.14.99.26 1.3l1.86 1.41a7.343 7.343 0 0 0 0 1.35l-1.86 1.41c-.4.3-.51.86-.26 1.3l1.87 3.23c.25.44.79.62 1.25.42l2.15-.91c.37.26.76.49 1.17.68l.29 2.31c.06.5.49.88.99.88h3.73c.5 0 .93-.38.99-.88l.29-2.31c.41-.19.8-.42 1.17-.68l2.15.91c.46.2 1 .02 1.25-.42l1.87-3.23c.25-.44.14-.99-.26-1.3l-1.86-1.41c.03-.23.04-.45.04-.68zm-7.46 3.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/>',f.close='<path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/>',f.arrowDown='<path d="M8.12 9.29 12 13.17l3.88-3.88a.996.996 0 1 1 1.41 1.41l-4.59 4.59a.996.996 0 0 1-1.41 0L6.7 10.7a.996.996 0 0 1 0-1.41c.39-.38 1.03-.39 1.42 0z"/>',f.zoomIn='<path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/><path d="M12 10h-2v2H9v-2H7V9h2V7h1v2h2v1z"/>',f.zoomOut='<path d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 0 0 1.48-5.34c-.47-2.78-2.79-5-5.59-5.34a6.505 6.505 0 0 0-7.27 7.27c.34 2.8 2.56 5.12 5.34 5.59a6.5 6.5 0 0 0 5.34-1.48l.27.28v.79l4.26 4.25c.41.41 1.07.41 1.48 0l.01-.01c.41-.41.41-1.07 0-1.48L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14zm-2-5h4c.28 0 .5.22.5.5s-.22.5-.5.5h-4c-.28 0-.5-.22-.5-.5s.22-.5.5-.5z"/>';class S{constructor(t,e,s,i,n){this.resetButton=t,this.zoomInButton=e,this.zoomOutButton=s,this.moveButton=i,this.deleteButton=n}static create(t){const e=C.element("div",{class:"sqd-control-bar"}),s=n(f.delete,"Delete selected step");s.classList.add("sqd-hidden");const i=n(f.center,"Reset"),o=n(f.zoomIn,"Zoom in"),r=n(f.zoomOut,"Zoom out"),a=n(f.move,"Turn on/off drag and drop");return a.classList.add("sqd-disabled"),e.appendChild(i),e.appendChild(o),e.appendChild(r),e.appendChild(a),e.appendChild(s),t.appendChild(e),new S(i,o,r,a,s)}bindResetButtonClick(t){i(this.resetButton,t)}bindZoomInButtonClick(t){i(this.zoomInButton,t)}bindZoomOutButtonClick(t){i(this.zoomOutButton,t)}bindMoveButtonClick(t){i(this.moveButton,t)}bindDeleteButtonClick(t){i(this.deleteButton,t)}setIsDeleteButtonHidden(t){C.toggleClass(this.deleteButton,t,"sqd-hidden")}setIsMoveButtonDisabled(t){C.toggleClass(this.moveButton,t,"sqd-disabled")}}class y{constructor(t,e){this.view=t,this.context=e}static create(t,e){const s=S.create(t),i=new y(s,e);return s.bindResetButtonClick(()=>i.onResetButtonClicked()),s.bindZoomInButtonClick(()=>i.onZoomInButtonClicked()),s.bindZoomOutButtonClick(()=>i.onZoomOutButtonClicked()),s.bindMoveButtonClick(()=>i.onMoveButtonClicked()),s.bindDeleteButtonClick(()=>i.onDeleteButtonClicked()),e.onIsReadonlyChanged.subscribe(()=>i.onIsReadonlyChanged()),e.onSelectedStepChanged.subscribe(()=>i.onSelectedStepChanged()),e.onIsMoveModeEnabledChanged.subscribe(t=>i.onIsMoveModeEnabledChanged(t)),i}onResetButtonClicked(){this.context.resetViewPort()}onZoomInButtonClicked(){this.context.zoom(!0)}onZoomOutButtonClicked(){this.context.zoom(!1)}onMoveButtonClicked(){this.context.toggleIsMoveModeEnabled(),this.context.selectedStep&&this.context.setSelectedStep(null)}onDeleteButtonClicked(){this.context.selectedStep&&this.context.deleteStepById(this.context.selectedStep.id)}onIsReadonlyChanged(){this.refreshDeleteButtonVisibility()}onSelectedStepChanged(){this.refreshDeleteButtonVisibility()}onIsMoveModeEnabledChanged(t){this.view.setIsMoveButtonDisabled(!t)}refreshDeleteButtonVisibility(){const t=!this.context.selectedStep||this.context.isReadonly;this.view.setIsDeleteButtonHidden(t)}}class x{constructor(t){this.root=t}static create(t){const e=C.element("div",{class:"sqd-global-editor"});return e.appendChild(t),new x(e)}}class b{constructor(t){this.view=t}static create(t,e){const s=e(t),i=x.create(s);return new b(i)}}class I{constructor(t,e,s){this.root=t,this.toggle=e,this.toggleIcon=s}static create(t){const e=C.element("div",{class:"sqd-smart-editor"}),s=C.element("div",{class:"sqd-smart-editor-toggle",title:"Toggle editor"}),i=f.create("sqd-smart-editor-toggle-icon");return s.appendChild(i),t.appendChild(s),t.appendChild(e),new I(e,s,i)}bindToggleIsCollapsedClick(t){this.toggle.addEventListener("click",e=>{e.preventDefault(),t()},!1)}setIsCollapsed(t){C.toggleClass(this.root,t,"sqd-hidden"),C.toggleClass(this.toggle,t,"sqd-collapsed"),this.toggleIcon.innerHTML=t?f.options:f.close}setView(t){this.view&&this.root.removeChild(this.view.root),this.root.appendChild(t.root),this.view=t}}class E{constructor(t){this.root=t}static create(t){const e=C.element("div",{class:"sqd-step-editor"});return e.appendChild(t),new E(e)}}class M{constructor(t){this.view=t}static create(t,e){const s=e(t),i=E.create(s);return new M(i)}}class P{constructor(t,e){this.view=t,this.context=e,this.currentStep=void 0}static create(t,e){const s=I.create(t);s.setIsCollapsed(e.isSmartEditorCollapsed);const i=new P(s,e);return s.bindToggleIsCollapsedClick(()=>i.toggleIsCollapsedClick()),i.tryRender(null),e.onSelectedStepChanged.subscribe(t=>i.onSelectedStepChanged(t)),e.onDefinitionChanged.subscribe(()=>i.onDefinitionChanged()),e.onIsSmartEditorCollapsedChanged.subscribe(t=>s.setIsCollapsed(t)),i}toggleIsCollapsedClick(){this.context.toggleIsSmartEditorCollapsed()}onSelectedStepChanged(t){this.tryRender(t)}onDefinitionChanged(){this.tryRender(this.context.selectedStep)}tryRender(t){if(this.currentStep!==t){const e=t?M.create(t,this.context.configuration.editors.stepEditorProvider):b.create(this.context.definition,this.context.configuration.editors.globalEditorProvider);this.currentStep=t,this.view.setView(e.view)}}}class D{constructor(t,e){this.root=t,this.viewport=e,this.onResizeHandler=(()=>this.onResize()),this.onTouchMoveHandler=(t=>this.onTouchMove(t)),this.onMouseMoveHandler=(t=>this.onMouseMove(t)),this.onTouchEndHandler=(t=>this.onTouchEnd(t)),this.onMouseUpHandler=(t=>this.onMouseUp(t))}static create(t,e){const s=C.element("div",{class:"sqd-scrollbox"});t.appendChild(s);const i=new D(s,e);return window.addEventListener("resize",i.onResizeHandler,!1),s.addEventListener("wheel",t=>i.onWheel(t),!1),s.addEventListener("touchstart",t=>i.onTouchStart(t),!1),s.addEventListener("mousedown",t=>i.onMouseDown(t),!1),i}setContent(t){this.content&&this.root.removeChild(this.content.element),t.classList.add("sqd-scrollbox-body"),this.root.appendChild(t),this.reload(t)}refresh(){this.content&&this.reload(this.content.element)}destroy(){window.removeEventListener("resize",this.onResizeHandler,!1)}reload(t){const e=.7,s=200;let i=Math.min(this.viewport.clientHeight*e,t.clientHeight);i=Math.min(i,this.viewport.clientHeight-s),this.root.style.height=i+"px",t.style.top="0px",this.content={element:t,height:i}}onResize(){this.refresh()}onWheel(t){if(t.stopPropagation(),this.content){const e=t.deltaY>0?-25:25,s=this.getScrollTop();this.setScrollTop(s+e)}}onTouchStart(t){t.preventDefault(),this.startScroll(e(t))}onMouseDown(e){this.startScroll(t(e))}onTouchMove(t){t.preventDefault(),this.moveScroll(e(t))}onMouseMove(e){e.preventDefault(),this.moveScroll(t(e))}onTouchEnd(t){t.preventDefault(),this.stopScroll()}onMouseUp(t){t.preventDefault(),this.stopScroll()}startScroll(t){this.scroll||(window.addEventListener("touchmove",this.onTouchMoveHandler,!1),window.addEventListener("mousemove",this.onMouseMoveHandler,!1),window.addEventListener("touchend",this.onTouchEndHandler,!1),window.addEventListener("mouseup",this.onMouseUpHandler,!1)),this.scroll={startPositionY:t.y,startScrollTop:this.getScrollTop()}}moveScroll(t){if(this.scroll){const e=t.y-this.scroll.startPositionY;this.setScrollTop(this.scroll.startScrollTop+e)}}stopScroll(){this.scroll&&(window.removeEventListener("touchmove",this.onTouchMoveHandler,!1),window.removeEventListener("mousemove",this.onMouseMoveHandler,!1),window.removeEventListener("touchend",this.onTouchEndHandler,!1),window.removeEventListener("mouseup",this.onMouseUpHandler,!1),this.scroll=void 0)}getScrollTop(){return this.content&&this.content.element.style.top?parseInt(this.content.element.style.top):0}setScrollTop(t){if(this.content){const e=this.content.element.clientHeight-this.content.height,s=Math.max(Math.min(t,0),-e);this.content.element.style.top=s+"px"}}}var B,q;(function(t){t[t.default=0]="default",t[t.selected=1]="selected",t[t.dragging=2]="dragging"})(B||(B={})),function(t){t.task="task",t.switch="switch",t.container="container"}(q||(q={}));class T{constructor(t,e,s){this.element=t,this.parentSequence=e,this.index=s}setIsHover(t){C.toggleClass(this.element,t,"sqd-hover")}}class H{static createStraightJoin(t,e,s){const i=C.svg("line",{class:"sqd-join",x1:e.x,y1:e.y,x2:e.x,y2:e.y+s});t.insertBefore(i,t.firstChild)}static createJoins(t,e,s){for(const i of s){const s=Math.abs(e.y-i.y)/2,n=Math.abs(e.x-i.x)-2*s,o=e.x>i.x?-1:1,r=e.y>i.y?-1:1,a=C.svg("path",{class:"sqd-join",fill:"none",d:`M ${e.x} ${e.y} q ${o*s*.3} ${r*s*.8} ${o*s} ${r*s} l ${o*n} 0 q ${o*s*.7} ${r*s*.2} ${o*s} ${r*s}`});t.insertBefore(a,t.firstChild)}}}const L=100,V=24;class k{constructor(t,e,s,i,n,o){this.g=t,this.width=e,this.height=s,this.joinX=i,this.placeholders=n,this.components=o}static create(t,e,s){const i=C.svg("g");t.appendChild(i);const n=e.map(t=>vt.create(i,t,e,s)),r=n.length>0?Math.max(...n.map(t=>t.view.joinX)):L/2,a=n.length>0?Math.max(...n.map(t=>t.view.width)):L;let c=V;const h=[];for(let t=0;t<n.length;t++){const e=n[t],s=r-e.view.joinX;H.createStraightJoin(i,new l(r,c-V),V),h.push(o(i,r-L/2,c-V)),C.translate(e.view.g,s,c),c+=e.view.height+V}return H.createStraightJoin(i,new l(r,c-V),V),h.push(o(i,r-L/2,c-V)),new k(i,a,c,r,h,n)}getClientPosition(){throw new Error("Not supported")}setIsDragging(t){this.placeholders.forEach(e=>{C.attrs(e,{visibility:t?"visible":"hidden"})})}}class z{constructor(t,e){this.view=t,this.sequence=e}static create(t,e,s){const i=k.create(t,e,s);return new z(i,e)}findByElement(t){for(const e of this.view.components){const s=e.findByElement(t);if(s)return s}return null}findById(t){for(const e of this.view.components){const s=e.findById(t);if(s)return s}return null}getPlaceholders(t){this.view.placeholders.forEach((e,s)=>{t.push(new T(e,this.sequence,s))}),this.view.components.forEach(e=>e.getPlaceholders(t))}setIsDragging(t){this.view.setIsDragging(t),this.view.components.forEach(e=>e.setIsDragging(t))}validate(){return this.view.components.every(t=>t.validate())}}const R=18,$=14,U=7;class j{constructor(t){this.root=t}static createRectInput(t,e,s,i){const n=C.svg("g");t.appendChild(n);const o=C.svg("rect",{class:"sqd-input",width:R,height:R,x:e-R/2,y:s+R/-2+.5,rx:4,ry:4});if(n.appendChild(o),i){const t=C.svg("image",{href:i,width:$,height:$,x:e-$/2,y:s+$/-2});n.appendChild(t)}return new j(n)}static createRoundInput(t,e,s){const i=C.svg("circle",{class:"sqd-input",cx:e,xy:s,r:U});return t.appendChild(i),new j(i)}setIsHidden(t){C.attrs(this.root,{visibility:t?"hidden":"visible"})}}const A=22,O=10,X=50;class Z{static create(t,e,s,i,n){const o=C.svg("text",{class:"sqd-label-text",x:e,y:s+A/2});o.textContent=i,t.appendChild(o);const r=Math.max(o.getBBox().width+2*O,X),a=C.svg("rect",{class:"sqd-label-rect",width:r,height:A,x:e-r/2,y:s,rx:10,ry:10});n&&a.classList.add(`sqd-label-${n}`),t.insertBefore(a,o)}}class J{constructor(t){this.regions=t}static create(t,e,s){const i=e.reduce((t,e)=>t+e,0),n=C.svg("rect",{class:"sqd-region",width:i,height:s,fill:"transparent",rx:5,ry:5}),o=[n];t.insertBefore(n,t.firstChild);let r=e[0];for(let i=1;i<e.length;i++){const n=C.svg("line",{class:"sqd-region",x1:r,y1:0,x2:r,y2:s});o.push(n),t.insertBefore(n,t.firstChild),r+=e[i]}return new J(o)}getClientPosition(){const t=this.regions[0].getBoundingClientRect();return new l(t.x,t.y)}setIsSelected(t){this.regions.forEach(e=>{C.toggleClass(e,t,"sqd-selected")})}}const W=20;class N{constructor(t){this.g=t}static create(t,e,s){const i=C.svg("g",{class:"sqd-hidden"});C.translate(i,e,s);const n=C.svg("path",{class:"sqd-validation-error",d:`M 0 ${-W/2} l ${W/2} ${W} l ${-W} 0 Z`});return i.appendChild(n),t.appendChild(i),new N(i)}setIsHidden(t){C.toggleClass(this.g,t,"sqd-hidden")}}const K=20,Y=20,F=22;class G{constructor(t,e,s,i,n,o,r,a){this.g=t,this.width=e,this.height=s,this.joinX=i,this.sequenceComponent=n,this.inputView=o,this.regionView=r,this.validationErrorView=a}static create(t,e,s){const i=C.svg("g");t.appendChild(i);const n=z.create(i,e.sequence,s);C.translate(n.view.g,Y,K+F);const o=n.view.width+2*Y,r=n.view.height+K+F,a=n.view.joinX+Y;Z.create(i,a,K,e.name);const c=s.iconUrlProvider?s.iconUrlProvider(e.componentType,e.type):null,h=j.createRectInput(i,a,0,c);H.createStraightJoin(i,new l(a,0),K);const d=J.create(i,[o],r),p=N.create(i,o,0);return new G(i,o,r,a,n,h,d,p)}getClientPosition(){return this.regionView.getClientPosition()}containsElement(t){return this.g.contains(t)}setIsDragging(t){this.inputView.setIsHidden(t),this.sequenceComponent.setIsDragging(t)}setIsSelected(t){this.regionView.setIsSelected(t)}setIsDisabled(t){C.toggleClass(this.g,t,"sqd-disabled")}setIsValid(t){this.validationErrorView.setIsHidden(t)}}class Q{constructor(t,e,s,i){this.view=t,this.step=e,this.parentSequence=s,this.configuration=i,this.currentState=B.default}static create(t,e,s,i){const n=G.create(t,e,i);return new Q(n,e,s,i)}findByElement(t){const e=this.view.sequenceComponent.findByElement(t);return e||(this.view.containsElement(t)?this:null)}findById(t){const e=this.view.sequenceComponent.findById(t);return e||(this.step.id===t?this:null)}getPlaceholders(t){this.currentState!==B.dragging&&this.view.sequenceComponent.getPlaceholders(t)}setState(t){switch(this.currentState=t,t){case B.default:this.view.setIsSelected(!1),this.view.setIsDisabled(!1);break;case B.selected:this.view.setIsSelected(!0),this.view.setIsDisabled(!1);break;case B.dragging:this.view.setIsSelected(!1),this.view.setIsDisabled(!0)}}setIsDragging(t){this.view.setIsDragging(t)}validate(){const t=!this.configuration.validator||this.configuration.validator(this.step);this.view.setIsValid(t);const e=this.view.sequenceComponent.validate();return t&&e}}const _=50,tt=20,et=20,st=22,it=16;class nt{constructor(t,e,s,i,n,o,r,a){this.g=t,this.width=e,this.height=s,this.joinX=i,this.sequenceComponents=n,this.regionView=o,this.inputView=r,this.validationErrorView=a}static create(t,e,s){const i=C.svg("g",{class:"sqd-switch-group"});t.appendChild(i);const n=Object.keys(e.branches),o=n.map(t=>z.create(i,e.branches[t],s)),r=Math.max(...o.map(t=>t.view.height)),a=o.map(t=>Math.max(t.view.width,_)+2*tt),c=a.reduce((t,e)=>t+e,0),h=r+et+2*st+2*it,d=[],p=o.map(t=>Math.max(t.view.joinX,_/2));let u=0;for(let t=0;t<n.length;t++)d.push(u),u+=a[t];n.forEach((t,e)=>{const s=o[e],n=d[e];Z.create(i,n+p[e]+tt,et+st+it,t,"secondary");const r=et+2*st+it+s.view.height,a=h-r-it;a>0&&H.createStraightJoin(i,new l(d[e]+p[e]+tt,r),a);const c=n+tt+Math.max((_-s.view.width)/2,0),u=et+2*st+it;C.translate(s.view.g,c,u)}),Z.create(i,a[0],et,e.name),H.createStraightJoin(i,new l(a[0],0),et);const g=s.iconUrlProvider?s.iconUrlProvider(e.componentType,e.type):null,v=j.createRectInput(i,a[0],0,g);H.createJoins(i,new l(a[0],et+st),d.map((t,e)=>new l(t+p[e]+tt,et+st+it))),H.createJoins(i,new l(a[0],h),d.map((t,e)=>new l(t+p[e]+tt,et+it+2*st+r)));const w=J.create(i,a,h),m=N.create(i,c,0);return new nt(i,c,h,a[0],o,w,v,m)}getClientPosition(){return this.regionView.getClientPosition()}containsElement(t){return this.g.contains(t)}setIsDragging(t){this.inputView.setIsHidden(t)}setIsSelected(t){this.regionView.setIsSelected(t)}setIsDisabled(t){C.toggleClass(this.g,t,"sqd-disabled")}setIsValid(t){this.validationErrorView.setIsHidden(t)}}class ot{constructor(t,e,s,i){this.view=t,this.step=e,this.parentSequence=s,this.configuration=i,this.currentState=B.default}static create(t,e,s,i){const n=nt.create(t,e,i);return new ot(n,e,s,i)}findByElement(t){for(const e of this.view.sequenceComponents){const s=e.findByElement(t);if(s)return s}return this.view.containsElement(t)?this:null}findById(t){if(this.step.id===t)return this;for(const e of this.view.sequenceComponents){const s=e.findById(t);if(s)return s}return null}getPlaceholders(t){this.currentState!==B.dragging&&this.view.sequenceComponents.forEach(e=>e.getPlaceholders(t))}setIsDragging(t){this.currentState!==B.dragging&&this.view.sequenceComponents.forEach(e=>e.setIsDragging(t)),this.view.setIsDragging(t)}setState(t){switch(this.currentState=t,t){case B.default:this.view.setIsSelected(!1),this.view.setIsDisabled(!1);break;case B.selected:this.view.setIsSelected(!0),this.view.setIsDisabled(!1);break;case B.dragging:this.view.setIsSelected(!1),this.view.setIsDisabled(!0)}}validate(){const t=!this.configuration.validator||this.configuration.validator(this.step);this.view.setIsValid(t);const e=this.view.sequenceComponents.every(t=>t.validate());return t&&e}}const rt=5;class at{constructor(t){this.root=t}static create(t,e,s){const i=C.svg("circle",{class:"sqd-output",cx:e,cy:s,r:rt});return t.appendChild(i),new at(i)}setIsHidden(t){C.attrs(this.root,{visibility:t?"hidden":"visible"})}}const ct=12,lt=10,ht=70,dt=22,pt=5;class ut{constructor(t,e,s,i,n,o,r,a){this.g=t,this.width=e,this.height=s,this.joinX=i,this.rect=n,this.inputView=o,this.outputView=r,this.validationErrorView=a}static create(t,e,s){const i=C.svg("g",{class:`sqd-task-group sqd-task-${e.type}`});t.appendChild(i);const n=dt+2*lt,o=C.svg("text",{x:dt+2*ct,y:n/2,class:"sqd-task-text"});o.textContent=e.name,i.appendChild(o);const r=Math.max(o.getBBox().width,ht),a=dt+3*ct+r,c=C.svg("rect",{x:.5,y:.5,class:"sqd-task-rect",width:a,height:n,rx:pt,ry:pt});i.insertBefore(c,o);const l=s.iconUrlProvider?s.iconUrlProvider(e.componentType,e.type):null,h=l?C.svg("image",{href:l}):C.svg("rect",{class:"sqd-task-empty-icon",rx:4,ry:4});C.attrs(h,{x:ct,y:lt,width:dt,height:dt}),i.appendChild(h);const d=j.createRoundInput(i,a/2,0),p=at.create(i,a/2,n),u=N.create(i,a,0);return new ut(i,a,n,a/2,c,d,p,u)}getClientPosition(){const t=this.rect.getBoundingClientRect();return new l(t.x,t.y)}containsElement(t){return this.g.contains(t)}setIsDragging(t){this.inputView.setIsHidden(t),this.outputView.setIsHidden(t)}setIsDisabled(t){C.toggleClass(this.g,t,"sqd-disabled")}setIsSelected(t){C.toggleClass(this.rect,t,"sqd-selected")}setIsValid(t){this.validationErrorView.setIsHidden(t)}}class gt{constructor(t,e,s,i){this.view=t,this.step=e,this.parentSequence=s,this.configuration=i}static create(t,e,s,i){const n=ut.create(t,e,i);return new gt(n,e,s,i)}findByElement(t){return this.view.containsElement(t)?this:null}findById(t){return this.step.id===t?this:null}getPlaceholders(){}setIsDragging(t){this.view.setIsDragging(t)}setState(t){switch(t){case B.default:this.view.setIsSelected(!1),this.view.setIsDisabled(!1);break;case B.selected:this.view.setIsDisabled(!1),this.view.setIsSelected(!0);break;case B.dragging:this.view.setIsDisabled(!0),this.view.setIsSelected(!1)}}validate(){const t=!this.configuration.validator||this.configuration.validator(this.step);return this.view.setIsValid(t),t}}class vt{static create(t,e,s,i){switch(e.componentType){case q.task:return gt.create(t,e,s,i);case q.switch:return ot.create(t,e,s,i);case q.container:return Q.create(t,e,s,i);default:throw new Error(`Unknown component type: ${e.componentType}`)}}}const wt=10;class mt{constructor(t,e,s){this.width=t,this.height=e,this.layer=s}static create(t,e){const s=e.theme||"light",i=C.element("div",{class:`sqd-drag sqd-theme-${s}`});document.body.appendChild(i);const n=C.svg("svg");i.appendChild(n);const o=[],r=vt.create(n,t,o,e.steps);return C.attrs(n,{width:r.view.width+2*wt,height:r.view.height+2*wt}),C.translate(r.view.g,wt,wt),new mt(r.view.width,r.view.height,i)}setPosition(t){this.layer.style.top=t.y-wt+"px",this.layer.style.left=t.x-wt+"px"}remove(){document.body.removeChild(this.layer)}}class Ct{constructor(t,e){this.placeholders=t,this.context=e,this.clearCacheHandler=(()=>this.clearCache())}static create(t,e){const s=new Ct(t,e);return e.onViewPortChanged.subscribe(s.clearCacheHandler),window.addEventListener("scroll",s.clearCacheHandler,!1),s}find(t,e,s){var i;this.cache||(this.cache=this.placeholders.map(t=>{const e=t.element.getBoundingClientRect();return{placeholder:t,lt:new l(e.x,e.y),br:new l(e.x+e.width,e.y+e.height)}}),this.cache.sort((t,e)=>t.lt.y-e.lt.y));const n=t.x+e,o=t.y+s;return null===(i=this.cache.find(e=>Math.max(t.x,e.lt.x)<Math.min(n,e.br.x)&&Math.max(t.y,e.lt.y)<Math.min(o,e.br.y)))||void 0===i?void 0:i.placeholder}destroy(){this.context.onViewPortChanged.unsubscribe(this.clearCacheHandler),window.removeEventListener("scroll",this.clearCacheHandler,!1)}clearCache(){this.cache=void 0}}class ft{constructor(t,e,s,i){this.view=t,this.context=e,this.step=s,this.pressedStepComponent=i}static create(t,e,s){const i=mt.create(e,t.configuration);return new ft(i,t,e,s)}onStart(t){let e;if(this.pressedStepComponent){this.pressedStepComponent.setState(B.dragging);const s=this.pressedStepComponent.view.getClientPosition();e=t.subtract(s)}else e=new l(this.view.width/2,this.view.height/2);this.view.setPosition(t.subtract(e)),this.context.setIsDragging(!0),this.state={startPosition:t,finder:Ct.create(this.context.getPlacehodlers(),this.context),offset:e}}onMove(t){if(this.state){const e=this.state.startPosition.subtract(t).subtract(this.state.offset);this.view.setPosition(e);const s=this.state.finder.find(e,this.view.width,this.view.height);this.currentPlaceholder!==s&&(this.currentPlaceholder&&this.currentPlaceholder.setIsHover(!1),s&&s.setIsHover(!0),this.currentPlaceholder=s)}}onEnd(t){this.view.remove(),this.context.setIsDragging(!1),!t&&this.currentPlaceholder?(this.pressedStepComponent?g.moveStep(this.pressedStepComponent.parentSequence,this.pressedStepComponent.step,this.currentPlaceholder.parentSequence,this.currentPlaceholder.index):(g.insertStep(this.step,this.currentPlaceholder.parentSequence,this.currentPlaceholder.index),this.context.setSelectedStep(this.step)),this.context.notifiyDefinitionChanged()):(this.pressedStepComponent&&this.pressedStepComponent.setState(B.default),this.currentPlaceholder&&this.currentPlaceholder.setIsHover(!1)),this.currentPlaceholder=void 0,this.state&&(this.state.finder.destroy(),this.state=void 0)}}class St{constructor(t){this.root=t}static create(t,e,s){const i=C.element("div",{class:"sqd-toolbox-item",title:e.name
}),n=s.iconUrlProvider?s.iconUrlProvider(e.componentType,e.type):null,o=C.element("div",{class:"sqd-toolbox-item-icon"});if(n){const t=C.element("img",{class:"sqd-toolbox-item-icon-image",src:n});o.appendChild(t)}else o.classList.add("sqd-no-icon");const r=C.element("div",{class:"sqd-toolbox-item-text"});return r.textContent=e.name,i.appendChild(o),i.appendChild(r),t.appendChild(i),new St(i)}bindMousedown(t){this.root.addEventListener("mousedown",t,!1)}bindTouchstart(t){this.root.addEventListener("touchstart",t,!1)}bindContextMenu(t){this.root.addEventListener("contextmenu",t,!1)}}class yt{constructor(t,e){this.step=t,this.context=e}static create(t,e,s){const i=St.create(t,e,s.configuration.steps),n=new yt(e,s);return i.bindMousedown(t=>n.onMousedown(t)),i.bindTouchstart(t=>n.onTouchstart(t)),i.bindContextMenu(t=>n.onContextMenu(t)),n}onTouchstart(t){t.preventDefault(),1===t.touches.length&&(t.stopPropagation(),this.startDrag(e(t)))}onMousedown(e){e.stopPropagation();const s=0===e.button;s&&this.startDrag(t(e))}onContextMenu(t){t.preventDefault()}startDrag(t){if(!this.context.isReadonly){const e=r(this.step);this.context.behaviorController.start(t,ft.create(this.context,e))}}}class xt{constructor(t,e,s,i,n,o){this.header=t,this.headerToggleIcon=e,this.body=s,this.filterInput=i,this.scrollboxView=n,this.context=o}static create(t,e){const s=C.element("div",{class:"sqd-toolbox"}),i=C.element("div",{class:"sqd-toolbox-header"}),n=C.element("div",{class:"sqd-toolbox-header-title"});n.innerText="Toolbox";const o=f.create("sqd-toolbox-toggle-icon"),r=C.element("div",{class:"sqd-toolbox-body"}),a=C.element("input",{class:"sqd-toolbox-filter",type:"text",placeholder:"Search..."});s.appendChild(i),s.appendChild(r),i.appendChild(n),i.appendChild(o),r.appendChild(a),t.appendChild(s);const c=D.create(r,t);return new xt(i,o,r,a,c,e)}bindToggleIsCollapsedClick(t){function e(e){e.preventDefault(),t()}this.header.addEventListener("click",e,!1)}bindFilterInputChange(t){function e(e){t(e.target.value)}this.filterInput.addEventListener("keyup",e,!1),this.filterInput.addEventListener("blur",e,!1)}setIsCollapsed(t){C.toggleClass(this.body,t,"sqd-hidden"),this.headerToggleIcon.innerHTML=t?f.arrowDown:f.close,t||this.scrollboxView.refresh()}setGroups(t){const e=C.element("div");t.forEach(t=>{const s=C.element("div",{class:"sqd-toolbox-group-title"});s.innerText=t.name,e.appendChild(s),t.steps.forEach(t=>yt.create(e,t,this.context))}),this.scrollboxView.setContent(e)}destroy(){this.scrollboxView.destroy()}}class bt{constructor(t,e){this.view=t,this.context=e}static create(t,e){const s=xt.create(t,e);s.setIsCollapsed(e.isToolboxCollapsed);const i=new bt(s,e);return i.render(),e.onIsToolboxCollapsedChanged.subscribe(t=>i.onIsToolboxCollapsedChanged(t)),s.bindToggleIsCollapsedClick(()=>i.toggleIsCollapsedClick()),s.bindFilterInputChange(t=>i.onFilterInputChanged(t)),i}destroy(){this.view.destroy()}render(){const t=this.context.configuration.toolbox.groups.map(t=>({name:t.name,steps:t.steps.filter(t=>!this.filter||t.name.toLowerCase().includes(this.filter))})).filter(t=>t.steps.length>0);this.view.setGroups(t)}toggleIsCollapsedClick(){this.context.toggleIsToolboxCollapsed()}onIsToolboxCollapsedChanged(t){this.view.setIsCollapsed(t)}onFilterInputChanged(t){this.filter=t.toLowerCase(),this.render()}}class It{constructor(t,e){this.startPosition=t,this.context=e}static create(t){return new It(t.viewPort.position,t)}onStart(){this.context.setSelectedStep(null)}onMove(t){const e=this.startPosition.subtract(t);this.context.setViewPort(e,this.context.viewPort.scale)}onEnd(){}}class Et{constructor(t,e){this.pressedStepComponent=t,this.context=e}static create(t,e){return new Et(t,e)}onStart(){}onMove(t){if(!this.context.isReadonly&&t.distance()>2)return this.context.setSelectedStep(null),ft.create(this.context,this.pressedStepComponent.step,this.pressedStepComponent)}onEnd(t){t||this.context.setSelectedStep(this.pressedStepComponent.step)}}const Mt=30;class Pt{constructor(t,e,s,i,n){this.g=t,this.width=e,this.height=s,this.joinX=i,this.component=n}static create(t,e,s){const i=C.svg("g");t.appendChild(i);const n=z.create(i,e,s),o=n.view,r=c(!0);C.translate(r,o.joinX-Mt/2,0),i.appendChild(r),C.translate(o.g,0,Mt);const a=c(!1);return C.translate(a,o.joinX-Mt/2,Mt+o.height),i.appendChild(a),new Pt(i,o.width,o.height+2*Mt,o.joinX,n)}getClientPosition(){throw new Error("Not supported")}destroy(){var t;null===(t=this.g.parentNode)||void 0===t||t.removeChild(this.g)}}class Dt{constructor(t){this.view=t}static create(t,e,s){const i=Pt.create(t,e,s);return new Dt(i)}findByElement(t){return this.view.component.findByElement(t)}findById(t){return this.view.component.findById(t)}getPlaceholders(t){this.view.component.getPlaceholders(t)}setIsDragging(t){this.view.component.setIsDragging(t)}validate(){return this.view.component.validate()}}const Bt=32;let qt=0;class Tt{constructor(t,e,s,i,n,o){this.workspace=t,this.canvas=e,this.gridPattern=s,this.gridPatternPath=i,this.foreground=n,this.configuration=o,this.onResizeHandler=(()=>this.onResize())}static create(t,e){const s=C.svg("defs"),i="sqd-grid-pattern-"+qt++,n=C.svg("pattern",{id:i,patternUnits:"userSpaceOnUse"}),o=C.svg("path",{class:"sqd-grid-path",fill:"none"});s.appendChild(n),n.appendChild(o);const r=C.svg("g"),a=C.element("div",{class:"sqd-workspace"}),c=C.svg("svg",{class:"sqd-workspace-canvas"});c.appendChild(s),c.appendChild(C.svg("rect",{width:"100%",height:"100%",fill:`url(#${i})`})),c.appendChild(r),a.appendChild(c),t.appendChild(a);const l=new Tt(a,c,n,o,r,e);return window.addEventListener("resize",l.onResizeHandler,!1),l}render(t){this.rootComponent&&this.rootComponent.view.destroy(),this.rootComponent=Dt.create(this.foreground,t,this.configuration),this.refreshSize()}setPositionAndScale(t,e){const s=Bt*e;C.attrs(this.gridPattern,{x:t.x,y:t.y,width:s,height:s}),C.attrs(this.gridPatternPath,{d:`M ${s} 0 L 0 0 0 ${s}`}),C.attrs(this.foreground,{transform:`translate(${t.x}, ${t.y}) scale(${e})`})}getClientPosition(){const t=this.canvas.getBoundingClientRect();return new l(t.x,t.y)}getClientSize(){return new l(this.canvas.clientWidth,this.canvas.clientHeight)}bindMouseDown(e){this.canvas.addEventListener("mousedown",s=>e(t(s),s.target,s.button),!1)}bindTouchStart(t){this.canvas.addEventListener("touchstart",s=>{s.preventDefault(),t(e(s))},!1)}bindContextMenu(t){this.canvas.addEventListener("contextmenu",t,!1)}bindWheel(t){this.canvas.addEventListener("wheel",t,!1)}destroy(){window.removeEventListener("resize",this.onResizeHandler,!1)}refreshSize(){C.attrs(this.canvas,{width:this.workspace.offsetWidth,height:this.workspace.offsetHeight})}onResize(){this.refreshSize()}}const Ht=.1,Lt=.2;class Vt{constructor(t,e){this.view=t,this.context=e,this.isValid=!1,this.selectedStepComponent=null}static create(t,e){const s=Tt.create(t,e.configuration.steps),i=new Vt(s,e);return setTimeout(()=>{i.render(),i.resetViewPort()}),e.setProvider(i),e.onViewPortChanged.subscribe(t=>i.onViewPortChanged(t)),e.onIsDraggingChanged.subscribe(t=>i.onIsDraggingChanged(t)),e.onIsSmartEditorCollapsedChanged.subscribe(()=>i.onIsSmartEditorCollapsedChanged()),a(0,e.onDefinitionChanged,e.onSelectedStepChanged).subscribe(t=>{const[e,s]=t;e?i.render():void 0!==s&&i.onSelectedStepChanged(s)}),s.bindMouseDown((t,e,s)=>i.onMouseDown(t,e,s)),s.bindTouchStart(t=>i.onTouchStart(t)),s.bindContextMenu(t=>i.onContextMenu(t)),s.bindWheel(t=>i.onWheel(t)),i}revalidate(){this.isValid=this.getRootComponent().validate()}render(){this.view.render(this.context.definition.sequence),this.trySelectStep(this.context.selectedStep),this.revalidate()}getPlaceholders(){const t=[];return this.getRootComponent().getPlaceholders(t),t}getSelectedStepComponent(){if(this.selectedStepComponent)return this.selectedStepComponent;throw new Error("Nothing selected")}findStepComponentById(t){return this.getRootComponent().findById(t)}resetViewPort(){const t=this.getRootComponent().view,e=this.view.getClientSize(),s=Math.max(0,(e.x-t.width)/2),i=Math.max(0,(e.y-t.height)/2);this.context.setViewPort(new l(s,i),1)}zoom(t){const e=t?Lt:-Lt,s=this.context.limitScale(this.context.viewPort.scale+e);this.context.setViewPort(this.context.viewPort.position,s)}moveViewPortToStep(t){const e=this.context.viewPort,s=t.view.getClientPosition(),i=this.view.getClientSize(),n=e.position.divideByScalar(e.scale).subtract(s.divideByScalar(e.scale)),o=new l(t.view.width,t.view.height).divideByScalar(2);this.context.animateViewPort(n.add(i.divideByScalar(2)).subtract(o),1)}destroy(){this.view.destroy()}onMouseDown(t,e,s){const i=0===s,n=1===s;(i||n)&&this.startBehavior(e,t,n)}onTouchStart(t){const e=document.elementFromPoint(t.x,t.y);e&&this.startBehavior(e,t,!1)}onContextMenu(t){t.preventDefault()}startBehavior(t,e,s){const i=s||this.context.isMoveModeEnabled?null:this.getRootComponent().findByElement(t);i?this.context.behaviorController.start(e,Et.create(i,this.context)):this.context.behaviorController.start(e,It.create(this.context))}onWheel(t){const e=this.context.viewPort,s=new l(t.pageX,t.pageY).subtract(this.view.getClientPosition()),i=s.divideByScalar(e.scale).subtract(e.position.divideByScalar(e.scale)),n=t.deltaY>0?-Ht:Ht,o=this.context.limitScale(e.scale+n),r=i.multiplyByScalar(-o).add(s),a=o;this.context.setViewPort(r,a)}onIsDraggingChanged(t){this.getRootComponent().setIsDragging(t)}onIsSmartEditorCollapsedChanged(){setTimeout(()=>this.view.refreshSize())}onViewPortChanged(t){this.view.setPositionAndScale(t.position,t.scale)}onSelectedStepChanged(t){this.trySelectStep(t)}trySelectStep(t){if(this.selectedStepComponent&&(this.selectedStepComponent.setState(B.default),this.selectedStepComponent=null),t){if(this.selectedStepComponent=this.getRootComponent().findById(t.id),!this.selectedStepComponent)throw new Error(`Cannot find a step component by id ${t.id}`);this.selectedStepComponent.setState(B.selected)}}getRootComponent(){if(this.view.rootComponent)return this.view.rootComponent;throw new Error("Root component not found")}}class kt{constructor(t,e,s,i){this.root=t,this.layoutController=e,this.workspace=s,this.toolbox=i,this.onResizeHandler=(()=>this.onResize()),this.onKeyUpHandlers=[]}static create(t,e,s){const i=s.theme||"light",n=C.element("div",{class:`sqd-designer sqd-theme-${i}`});t.appendChild(n);const o=Vt.create(n,e);let r=void 0;s.toolbox.isHidden||(r=bt.create(n,e)),y.create(n,e),s.editors.isHidden||P.create(n,e);const a=new kt(n,e.layoutController,o,r);return a.reloadLayout(),window.addEventListener("resize",a.onResizeHandler,!1),a}bindKeyUp(t){document.addEventListener("keyup",t,!1),this.onKeyUpHandlers.push(t)}destroy(){var t,e;window.removeEventListener("resize",this.onResizeHandler,!1),this.onKeyUpHandlers.forEach(t=>document.removeEventListener("keyup",t,!1)),this.workspace.destroy(),null===(t=this.toolbox)||void 0===t||t.destroy(),null===(e=this.root.parentElement)||void 0===e||e.removeChild(this.root)}onResize(){this.reloadLayout()}reloadLayout(){const t=this.layoutController.isMobile();C.toggleClass(this.root,!t,"sqd-layout-desktop"),C.toggleClass(this.root,t,"sqd-layout-mobile")}}class zt{constructor(t){this.parent=t}isMobile(){return this.parent.clientWidth<400}}class Rt{constructor(t,e){this.view=t,this.context=e,this.onDefinitionChanged=new p}static create(t,e,s){const i=d.deepClone(e),n=new h,o=new zt(t),r=o.isMobile(),a=new m(i,n,o,s,r,r),c=kt.create(t,a,s),l=new Rt(c,a);return c.bindKeyUp(t=>l.onKeyUp(t)),a.onDefinitionChanged.subscribe(t=>l.onDefinitionChanged.forward(t)),l}static nextId(){return u.next()}getDefinition(){return this.context.definition}revalidate(){this.view.workspace.revalidate()}isValid(){return this.view.workspace.isValid}isReadonly(){return this.context.isReadonly}notifiyDefinitionChanged(){this.context.notifiyDefinitionChanged()}setIsReadonly(t){this.context.setIsReadonly(t)}getSelectedStepId(){var t;return(null===(t=this.context.selectedStep)||void 0===t?void 0:t.id)||null}selectStepById(t){this.context.selectStepById(t)}clearSelectedStep(){this.context.setSelectedStep(null)}moveViewPortToStep(t){this.context.moveViewPortToStep(t)}destroy(){this.view.destroy()}onKeyUp(t){const e=["Backspace","Delete"];if(!e.includes(t.key))return;const s=["input","textarea"];document.activeElement&&s.includes(document.activeElement.tagName.toLowerCase())||!this.context.selectedStep||this.context.isReadonly||this.context.isDragging||(t.preventDefault(),t.stopPropagation(),this.context.deleteStepById(this.context.selectedStep.id))}}return Rt});